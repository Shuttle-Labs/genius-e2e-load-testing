version: "3.8"

services:
  validator:
    image: solanalabs/solana:stable
    command: solana-test-validator --no-bpf-jit --limit-ledger-size
    ports:
      - "8899:8899"
      - "8900:8900"
    healthcheck:
      test: ["CMD", "curl", "-s", "http://127.0.0.1:8899"]
      interval: 3s
      timeout: 2s
      retries: 20

  e2e:
    build: .
    shm_size: 1g
    depends_on:
      validator:
        condition: service_healthy
    environment:
      PHANTOM_MODE: "real"
      SOLANA_RPC: "http://validator:8899"
      SOLANA_AIRDROP: "1"
    volumes:
      - ./:/work
    working_dir: /work
    command: >
      bash -lc "
        npm ci &&
        npm run setup:phantom &&
        npm run generate:wallets &&
        npx playwright test
      "
